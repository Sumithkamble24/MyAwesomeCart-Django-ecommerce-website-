{% extends 'shop/basic.html' %}
{% block title %}Home - My Shop{% endblock %}

{% block body %}
<div class="container my-4">
  {% for category, product_chunks, slide_range in all_products %}
    <h3 class="mb-3 d-flex justify-content-between align-items-center">
      <span>{{ category|default:"Category" }}</span>
      <a href="/shop/category/{{ category }}" class="btn btn-sm btn-outline-primary">View All</a>
    </h3>

    <div class="position-relative mb-5">
      <button class="carousel-control-prev custom-control" type="button" data-bs-target="#carousel{{ forloop.counter }}" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
      </button>
      <button class="carousel-control-next custom-control" type="button" data-bs-target="#carousel{{ forloop.counter }}" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
      </button>

      <div id="carousel{{ forloop.counter }}" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
          {% for products_chunk in product_chunks %}
          <div class="carousel-item {% if forloop.first %}active{% endif %}">
            <div class="row justify-content-start">
              {% for product in products_chunk %}
              <div class="col-md-3">
                <div class="card shadow-sm mb-3" style="height: 360px;">
                  <img src="/media/{{ product.image|default:'' }}" class="card-img-top"
                       style="height: 150px; object-fit: contain; padding: 10px;">
                  <div class="card-body p-2 text-center">
                    <h6 class="card-title text-truncate">{{ product.product_name|default_if_none:"Unknown" }}</h6>
                    <p class="card-text small text-muted" style="height: 32px;">
                      {{ product.desc|slice:":60"|default:"No description" }}...
                    </p>
                    <p class="fw-bold text-success mb-1">₹{{ product.price|default_if_none:"0" }}</p>

                    <div id="cart-controls-{{ product.product_id }}" class="d-flex justify-content-center gap-1"
                         data-name="{{ product.product_name|default_if_none:'Unknown' }}"
                         data-price="{{ product.price|default_if_none:'0' }}">
                      <a href="#" id="{{ product.product_id }}"
                         class="btn btn-success btn-sm add-to-cart"
                         data-name="{{ product.product_name|default_if_none:'Unknown' }}"
                         data-price="{{ product.price|default_if_none:'0' }}">
                         Add to Cart
                      </a>
                    </div>

                    <button class="btn btn-primary btn-sm mt-2"
                            data-bs-toggle="modal"
                            data-bs-target="#quickViewModal{{ product.product_id }}">
                      Quick View
                    </button>
                  </div>
                </div>
              </div>

              <!-- Quick View Modal -->
              <div class="modal fade" id="quickViewModal{{ product.product_id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">{{ product.product_name|default_if_none:"Unknown" }}</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body row">
                      <div class="col-md-4">
                        <img src="/media/{{ product.image|default:'' }}" class="img-fluid rounded">
                      </div>
                      <div class="col-md-4">
                        <p>{{ product.desc|default:"No description" }}</p>
                        <h4 class="text-success">₹{{ product.price|default_if_none:"0" }}</h4>
                        <div class="mt-3 d-flex gap-2">
                          <a href="#" id="{{ product.product_id }}"
                             class="btn btn-success add-to-cart"
                             data-name="{{ product.product_name|default_if_none:'Unknown' }}"
                             data-price="{{ product.price|default_if_none:'0' }}">
                             Add to Cart
                          </a>
                          <a href="/shop/products/{{ product.product_id }}" class="btn btn-primary">Buy Now</a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055">
  <div id="cartToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">Cart cleared!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<style>
.carousel-control-prev-icon,
.carousel-control-next-icon {
  background-color: rgba(0, 0, 0, 0.5);
  border-radius: 50%;
  padding: 10px;
}
.carousel-control-prev-icon:hover,
.carousel-control-next-icon:hover {
  background-color: rgba(0, 0, 0, 0.8);
}
.custom-control {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  z-index: 2;
  width: auto;
  height: auto;
  background: none;
  border: none;
}
.carousel-control-prev.custom-control { left: -30px; }
.carousel-control-next.custom-control { right: -30px; }
</style>
{% endblock %}

{% block js %}
<script>
console.log('Cart system working');
let cart = {};

if (localStorage.getItem('cart') !== null) {
    cart = JSON.parse(localStorage.getItem('cart'));
}
updateCartUI();

function updateCartUI() {
  let validCart = {};
  for (let id in cart) {
    if (cart[id] && cart[id].name && cart[id].price && cart[id].qty > 0) validCart[id] = cart[id];
  }
  cart = validCart;
  localStorage.setItem('cart', JSON.stringify(cart));

  let totalQty = Object.values(cart).reduce((a,b)=>a+(b.qty||0),0);
  document.getElementById('cart').innerText = totalQty;

  document.querySelectorAll('[id^="cart-controls-"]').forEach(div=>{
    let productId = div.id.replace("cart-controls-","");
    let name = div.getAttribute("data-name")||"Unknown Product";
    let price = parseFloat(div.getAttribute("data-price"))||0;

    if(cart[productId]){
      div.innerHTML = `<div class="d-flex justify-content-center align-items-center gap-1">
        <button class="btn btn-sm btn-danger minus-btn" data-id="${productId}">-</button>
        <span id="qty-${productId}">${cart[productId].qty}</span>
        <button class="btn btn-sm btn-success plus-btn" data-id="${productId}">+</button>
      </div>`;
    } else {
      div.innerHTML = `<a href="#" id="${productId}" class="btn btn-success btn-sm add-to-cart"
        data-name="${name}" data-price="${price}">Add to Cart</a>`;
    }
  });

  document.querySelectorAll('.plus-btn').forEach(btn=>btn.onclick=function(){
    let id=this.getAttribute('data-id');
    cart[id].qty+=1;
    localStorage.setItem('cart',JSON.stringify(cart));
    updateCartUI();
  });

  document.querySelectorAll('.minus-btn').forEach(btn=>btn.onclick=function(){
    let id=this.getAttribute('data-id');
    cart[id].qty-=1;
    if(cart[id].qty<=0) delete cart[id];
    localStorage.setItem('cart',JSON.stringify(cart));
    updateCartUI();
  });

  document.querySelectorAll('.add-to-cart').forEach(btn=>btn.onclick=function(e){
    e.preventDefault();
    let id=this.id.toString();
    let name=this.getAttribute("data-name")||"Unknown Product";
    let price=parseFloat(this.getAttribute("data-price"))||0;

    if(cart[id]) cart[id].qty+=1;
    else cart[id]={name:name,price:price,qty:1};

    localStorage.setItem('cart',JSON.stringify(cart));
    updateCartUI();
  });

  // Popover content
  let cartContent='';
  if(Object.keys(cart).length===0){
    cartContent='<p class="text-center mb-0">Your cart is empty</p>';
  } else {
    cartContent='<ul class="list-group">';
    for(let id in cart){
      if(cart[id]){
        cartContent+=`<li class="list-group-item d-flex justify-content-between align-items-center">
          ${cart[id].name} (x${cart[id].qty})
          <span>₹${(cart[id].price*cart[id].qty).toFixed(2)}</span>
        </li>`;
      }
    }
    cartContent+='</ul>';
    cartContent+=`<div class="mt-2 d-flex justify-content-between">
      <button class="btn btn-danger btn-sm" id="clearCartBtn">Clear Cart</button>
      <a href="/shop/checkout" class="btn btn-primary btn-sm">Go to Checkout</a>
    </div>`;
  }

  let cartTrigger=document.getElementById('cartPopover');
  let popover=bootstrap.Popover.getInstance(cartTrigger);

  if(!popover){
    popover = new bootstrap.Popover(cartTrigger, {
        html: true,
        content: '',
        placement: 'bottom'
    });
  }

  popover.setContent({'.popover-body': cartContent});

  // Attach clear cart AFTER popover is shown
  cartTrigger.addEventListener('shown.bs.popover', function () {
    const clearBtn = document.getElementById('clearCartBtn');
    if (clearBtn) {
      clearBtn.onclick = function () {
        cart = {};
        localStorage.removeItem('cart');
        updateCartUI();

        // Show toast
        const toastEl = document.getElementById('cartToast');
        const toast = new bootstrap.Toast(toastEl);
        toast.show();

        bootstrap.Popover.getInstance(cartTrigger).hide();
      };
    }
  });
}
</script>
{% endblock %}
